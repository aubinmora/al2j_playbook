---

- name: installation de mitogen
  hosts: localhost
  tasks:
    - name: create directory
      file:
        path: "/etc/ansible/{{ item }}"
        state: directory
      loop:
        - roles
        - ansible_playbooks
        - plugins
        - .ssh

    - name: installation de mitogen pour les clients UNIX
      block:
        - name: download de mitogen
          unarchive:
            src: "https://networkgenomics.com/try/mitogen-0.{{ ansible_version.major }}.{{ ansible_version.minor }}.tar.gz"
            dest: /etc/ansible/plugins
            remote_src: yes

        - name: edit ansible configuration file
          lineinfile:
            path: /etc/ansible/ansible.cfg
            state: present
            line: "strategy_plugins    = /etc/ansible/plugins/mitogen-0.{{ ansible_version.major }}.{{ ansible_version.minor }}/ansible_mitogen/plugins/strategy"
            regexp: '^\#?strategy_plugins.*'

        - name: edit ansible configuration file
          lineinfile:
            path: /etc/ansible/ansible.cfg
            state: present
            line: "roles_path    = /etc/ansible/roles"
            regexp: '^\#?roles_path.*'

- name: installation des utilitaires, roles et playbooks
  hosts: localhost
  vars:
    secure_ssh_git_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31366262633539373136643732303537643937323033303865316334633936373139383633366536
          3134356565396331633663366437396135313238366231370a656666663231333764313038303536
          30376333656234393566626538353662353861316531326339323231346638633732303866656132
          3531623932366236620a313536643232323561306263396265333732343239656562313863323336
          36373736323237336637386565613532333466393638326635373432653330316661663634363832
          30356637333631323063333362353338653637383031376334313738356234313361333233626536
          33313764656136646234336364393338616165633937343334316261666466646233323666333865
          37363335356361313139383763313536623632613034613139653465643033626331303866303931
          62313534363465313830633633613666386666306234333934393234373033663762393537383762
          38616166313732366236626363303364653865636333393738633838653863343935613831656233
          32653936326537336365383561336333623434366632633438373662626464326531623364343234
          62303734633434353337323765613765313763313033376133653234363833633866613962646362
          31663133303032323230353162623338393563343437383365373638636335353734336166353565
          33636634636663393432663366656134623830346565313363376631616461373630643466326432
          39343131333239626662313639336437396630313138316432373630306537353262323839383934
          35383862373661386339633466383138313265323136343231363839653935353965396262323665
          33346434366333353335656430336431376232653136333839363263653833393535376639393335
          63303063306338643837663937336439633533663833346336383135343832646561323032616363
          64366531613032633631613533393166623038393661623339393063333561306638303531343865
          34373266313836643937363731323165623434363138633231626366323330333632383931356364
          36633464366534663437393935323737626463373936333862633436333032343139653332663964
          33346263656266323833643735373261313161633336333537376264656130353665393264353463
          61646132666333623138393762353464313739323836306637376339653631616131643133376435
          62633238336465656366373762373537343733613234343431366536353638353462353663666530
          64343661623665303939633733316661373934333365646432343932316264643164346464633730
          35666164333232356435663038633863383833366566636635646561346262646239643962366237
          33656134303136613862316434643366366530643865656361666235326230356539616265326164
          35623562383366386535663631356136633764393539303530626335616365333630383436616332
          37393939306139633965333933313537356665333731353935643034376631333036333332373136
          33616539323364373538363966313464613564376438366361323039383239643263363037653263
          63343133306237633438313865373762393761646262656234316631333338393165323539343838
          62363266353139333636656361656336616333343138386231323463343565613432663766646561
          32333433653533623737346666323435333434653065323863376631363738633162326235643832
          36343666326361333937303464623233633833393065396364323738666138383463613834613739
          64366631616238356436633864383634666438336463643236616232626464643134396539353930
          35383337643433646162356461663830643166633436366462343161363238646165653163343534
          65343964643736346335363631656136343764343231316361613731646361376138383036363933
          36666163366534393665366263393734616161303430303330663739623338356133323732326637
          32353833323061646561393464383863396266636265323564626536303438633766386164643037
          65653538303239393639363035353539656561656363356535343937303764636266626461393832
          62373739383336356238303434323162373738353536663664656362643434613036616664323339
          35613664623966376439386137663630373033633530613163303231343762306132346430316536
          32323531366562383334653231633934643736656330396637363530363466376137323162336433
          61363132356264383231343966626562343137643363616130306330636131316562646539303964
          63636363336365353630633966623561303934313632633036396631353530356230626233646432
          65356661343033653738336532633831313561323663666635383562646663386662633138303463
          33643131343639376339363462613537643336626431353330663635336636646433383766313637
          34623764346163656663363865646430656333333465326265343231393235323563656662623637
          33613732363533613331376334653663363031653737353265653735386135633436666164663964
          35653135623635376563353362653034373032643135383436333239316637383938346139643437
          64616439643863306661643337303639643233386635386332386239613861623234613432353166
          31386231663831666365333034353432346365303936313330323064653562353736313466303963
          61666265353031643731633830393135316164313661393562313735373665643639323631633232
          63366264363563373235313666663830333664386565363036636566316666653835326362303038
          66343139343437393161663534386131336261636536613964663338333633353834306463616630
          37623137653566366133353134623063363632636438303061663032396565393366383766303862
          64396538663338363734373563636632396261396663663961646134323135323362663135313732
          39396637303138376133633236616236323961616262323532613433326132656334646663346137
          30396161663065333536373735643931613161323165333266303837663433636234393931623638
          61323731626631333737316539666134336231373632613634616666356535336566386430303239
          34333537326135373866376461373231396563336566313064663765306265356462653733313633
          62363737363561353862373763356461343239633638393661616332393537663366343466653935
          37346433373436346362666662623036346632616235306138623632333632363964656465666136
          66353965396135353462373035376366643965323063656262363561643737613161666564646562
          30346661376662356338636431303637396231613063316339653534353835653663343336316339
          64346231393064663730633536663964663539623461366139333461363962666666336439623363
          31633735326535356264396261343534376537343232343664623430333233613666333461333365
          64303166353233336434656332333063303636323930386363336661326135363036623638303638
          31393637386366376565663437386562613233386535333037636564386563383266373066653934
          63336433303035306564386431373836353336653266323639666563316362613164383966383434
          64616239633062653862653561396139623466633835633164653766303862613531656565346330
          33333464303239316365383337323665306133316238626439393366623463376261646338663461
          34346362346661393937663562666363346131643434326439343562616231646536646332386535
          63653765353230396666386461363335616333393164316135346530393537346634313139366566
          39323864323938323931303932346366343463383737343262613263643239316432663361626538
          30303032333439373136303733323533306231623863373063653031663365383438616164626336
          64353733653266346466316637366537353832613736626139316338663439323261643539383230
          35313666623336306430313561353133616562323333316238633164636532363461653963376463
          30336637666631343537666336333062643737656430653634653136646263646263303664336366
          30613533643737363639363431363231653034356165393266303238663932636135363632313566
          30333730623964656336396539373738646164653239363133363066623232613735336466396134
          61383562663137616364653764323031393138663766366133396562636565343966333335626538
          66303865623034396265343364323165333439666231303030393637396632303762363239653864
          38666234376337656462626532643337326439303262336536633531323864626431626237323930
          35666338383633306138353066356630663338363861323766653637393163336631356638336566
          66303335353163646238666466333961323764356638366336366663613164656131363064613338
          35666166616437353661383536323532306231383734316434343231633939623930373361376433
          36363335373336656165633865653431643565346130633330636431613732376336663362323363
          62636235373733346239623138303735356166353238626433336232396364643538653532346230
          66636339613061336535653130333835366530643132623361363330343261343334643332656337
          38663765616662313161373665393237386665346337366232633362323365393663623339343837
          35653865656661373933313531346131666233323630333334616563373537373761343535386262
          65353764636133376439383638393663386261643365313863636364336539663233623766366237
          32313761373234636266633437623134616533636631633330376636656333346334326563323661
          63343139616365386331323466396165633537373733663635623334393835656137383930626633
          33616264623162323033356561653535336636303038646630383566623161643739373038343264
          63336337626666376531323236666639663539313239646562393538636439613665646533653066
          61313764636161303437393731313866313865343934626638616461613733656635373637653434
          64653730653532356636333637653230636437653138313033303762333564616336633665663433
          62346432656534656139303263646331396137303662303539616438663031663566646434373666
          31653738383839663863366366663939653562313363386537336235616436376364363733396232
          66633635323163326232303064643763333666616132656131396431613939343531323637353132
          30343730376333626562613364336163663032663364613538326134346165616664323364316438
          35653664376134653966366631303532616661373164616363393336313038343138393335336536
          35373437636137373035313336633732656536626536343463643836656130333865656237346162
          31666636623736653836626531643938633739633138303265636130353264663135643536393435
          39353538396332633734353965646536393132313565396463343437653538613937386564636130
          30643935383636303330396463663766613037333630363734646561386236386262623033316663
          39656438393934316431393637646530633434343731643461666237323664393534396162643531
          30373638363766633339653336393032313034386237653535316338653261353264643332383635
          62613036663134346336356462386266323630656536656362323539353332353364386431363632
          37613030626364393262653463383530386664333934343866323039323133636135613365356432
          62623433666537306131613931626562643637626261633534356461363434313737623161383265
          33626532633530363532366132383739396136323935636266303032636565623438393132306265
          65333330313839363166653263393832343835376464613166353239393763353633636631393666
          36353937663431613662323261636262333232383362326438336539636666343234666538396363
          61393363623339393834343766303034333962653030323761623662323365373631333932323534
          39383466643138396363613465363832396632633562353331663336643831333738366231353230
          38383936373739636334333134653136666636306565626238396364393365623161356630323861
          62313431663866373530316235643131383038303039663764383461393938613064336138663730
          30613230326232663764353466633232626265316562356234653638306533653266663539613039
          30366664636334666230633135626366313162306132343162343737613038383863396239663636
          32333564366364393963646238383738656463623036313239366463646663643362366633343439
          37306665323464303134666461353335333834353763303961393333323737346266303564663665
          65663863653134343862346433613431386331313364363436336563633665613739383638383233
          33313263613965343737626163353335326432386136303632643538323435336339666662653861
          30663736363238653139383365333739353434353961343764363761636636343966393537653237
          62346233303934326564
  tasks:
    - name: install from generic repos
      package:
        name: 
          - git
          - python3-pip
          - rsync
        state: present

    - name: install from pip
      pip:
        name: ansible-lint

    - name: create private key file
      lineinfile:
        create: yes
        line: "{{ secure_ssh_git_key | b64decode }}"
        path: /etc/ansible/.ssh/git_key_file.rsa
        mode: '0400'

    - name: download git repos
      git:
        repo: "git@github.com:aubinmora/{{ item.repo }}.git"
        dest: "/etc/ansible/{{ item.folder_dest | default ('roles/') }}{{ item.repo}}"
        version: "{{ item.version | default ('master') }}"
        accept_hostkey: yes
        key_file: /etc/ansible/.ssh/git_key_file.rsa
      loop:
      - repo: prometheus_server_install
      - repo: bareos_client_install
      - repo: prometheus_node_exporter
      - repo: bareos_server_install
      - repo: ansible_socle
      - repo: prometheus_wmi_exporter
      - repo: ansible_playbooks
      - repo: mattermost_server_install
        folder_dest: /

    - name: download prometheus role
      command: ansible-galaxy install cloudalchemy.prometheus

    - name: cleanup
      file:
        path: /etc/ansible/.ssh
        state: absent
